#!/bin/bash
###############################################################################
# FAROSINT - Modo Avanzado (GUI Mejorada con YAD)
# Interfaz gr√°fica moderna para herramientas OSINT
# Versi√≥n: 2.0 - Migrado de Zenity a YAD
###############################################################################

# Colores para notificaciones
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Variables
OUTPUT_BASE="$HOME/FAROSINT/output"
mkdir -p "$OUTPUT_BASE"

# Iconos y tema
ICON_PATH="/usr/share/icons/hicolor/48x48/apps"
WINDOW_ICON="security-high"

# ============================================================================
# FUNCIONES AUXILIARES MEJORADAS
# ============================================================================

show_notification() {
    local title="$1"
    local message="$2"
    notify-send -i "$WINDOW_ICON" "$title" "$message" 2>/dev/null || echo "$title: $message"
}

run_in_terminal() {
    local title="$1"
    local command="$2"

    x-terminal-emulator -T "$title" -e bash -c "
        echo -e '\033[0;36m'
        echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
        echo '  $title'
        echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
        echo -e '\033[0m'
        echo ''
        $command
        echo ''
        echo -e '\033[0;32m‚úì Completado\033[0m'
        echo ''
        read -p 'Presiona ENTER para cerrar...' dummy
    " &
}

# ============================================================================
# MEN√ö PRINCIPAL (MEJORADO CON YAD)
# ============================================================================

main_menu() {
    choice=$(yad --list \
        --title="FAROSINT - Modo Avanzado" \
        --window-icon="$WINDOW_ICON" \
        --width=900 --height=600 --center \
        --text="<big><b>Framework de An√°lisis de Superficie de Ataque OSINT</b></big>\n\nSelecciona una categor√≠a de herramientas:" \
        --column="Icono":IMG --column="ID":HD --column="Categor√≠a" --column="Descripci√≥n" \
        --no-headers \
        --print-column=2 \
        --search-column=3 \
        --button="gtk-quit:1" \
        --button="Ejecutar!gtk-execute:0" \
        "network-workgroup" "1" "üì° Reconocimiento" "Enumeraci√≥n de subdominios, emails y assets" \
        "applications-internet" "2" "üåê An√°lisis Web" "Detecci√≥n de tecnolog√≠as y an√°lisis de aplicaciones web" \
        "network-wired" "3" "üîç Escaneo de Puertos" "Detecci√≥n de puertos abiertos y servicios" \
        "security-medium" "4" "üõ°Ô∏è Vulnerabilidades" "Detecci√≥n y an√°lisis de vulnerabilidades" \
        "folder-saved-search" "5" "üìä Resultados" "Ver y gestionar resultados de escaneos" \
        "preferences-system" "6" "‚öôÔ∏è Utilidades" "Actualizaci√≥n y mantenimiento del sistema")

    if [ $? -ne 0 ]; then
        exit 0
    fi

    case $choice in
        1) menu_reconocimiento ;;
        2) menu_web ;;
        3) menu_portscan ;;
        4) menu_vuln ;;
        5) menu_resultados ;;
        6) menu_utilidades ;;
        *) exit 0 ;;
    esac
}

# ============================================================================
# MEN√ö DE RECONOCIMIENTO (MEJORADO)
# ============================================================================

menu_reconocimiento() {
    while true; do
        choice=$(yad --list \
            --title="FAROSINT - Reconocimiento OSINT" \
            --window-icon="network-workgroup" \
            --width=950 --height=550 --center \
            --text="<b>Herramientas de Reconocimiento y Enumeraci√≥n</b>\n\nEnumera subdominios, busca assets y recolecta informaci√≥n:" \
            --column="Icono":IMG --column="ID":HD --column="Herramienta" --column="Descripci√≥n" --column="Velocidad" \
            --no-headers \
            --print-column=2 \
            --search-column=3 \
            --button="gtk-go-back:1" \
            --button="Ejecutar!gtk-execute:0" \
            "emblem-web" "subfinder" "Subfinder" "Enumeraci√≥n r√°pida de subdominios usando fuentes pasivas" "‚ö° Muy R√°pida" \
            "network-server" "amass" "Amass" "Enumeraci√≥n profunda con correlaci√≥n y DNS activo/pasivo" "üê¢ Lenta" \
            "mail-unread" "theharvester" "TheHarvester" "Recolecci√≥n de emails, subdominios y empleados" "‚ö° R√°pida" \
            "search" "shodan" "Shodan" "B√∫squeda en base de datos de dispositivos IoT" "‚ö° Instant√°nea" \
            "package-x-generic" "combo" "Combo Completo" "Ejecutar TODAS las herramientas de reconocimiento" "üê¢ Muy Lenta")

        if [ $? -ne 0 ]; then
            main_menu
            return
        fi

        case $choice in
            "subfinder") run_subfinder ;;
            "amass") run_amass ;;
            "theharvester") run_theharvester ;;
            "shodan") run_shodan ;;
            "combo") run_combo_recon ;;
        esac
    done
}

run_subfinder() {
    domain=$(yad --form \
        --title="Subfinder - Enumeraci√≥n de Subdominios" \
        --window-icon="emblem-web" \
        --width=550 --center \
        --text="<b>Subfinder</b> - Enumeraci√≥n r√°pida de subdominios\n\nUsando m√∫ltiples fuentes: DNSDumpster, Virustotal, CertSpotter, etc." \
        --field="üåê Dominio objetivo:" \
        --button="gtk-cancel:1" \
        --button="Escanear!gtk-execute:0")

    if [ $? -ne 0 ]; then
        return
    fi

    domain=$(echo "$domain" | cut -d'|' -f1)

    if [ -z "$domain" ]; then
        return
    fi

    OUTPUT_DIR="$OUTPUT_BASE/$(date +%Y%m%d_%H%M%S)_${domain}_subfinder"
    mkdir -p "$OUTPUT_DIR"

    show_notification "Subfinder" "Iniciando escaneo de $domain..."

    run_in_terminal "Subfinder - $domain" \
        "subfinder -d $domain -all -o $OUTPUT_DIR/subdomains.txt -v && \
         echo '' && \
         echo 'Resultados guardados en:' && \
         echo '$OUTPUT_DIR/subdomains.txt' && \
         echo '' && \
         echo 'Subdominios encontrados: '$(wc -l < $OUTPUT_DIR/subdomains.txt 2>/dev/null || echo 0)"

    # Preguntar si ejecutar Httpx despu√©s
    sleep 2
    yad --question \
        --title="Subfinder Completado" \
        --window-icon="emblem-web" \
        --width=450 --center \
        --text="<b>Escaneo completado</b>\n\n¬øDeseas verificar qu√© subdominios est√°n activos con Httpx?" \
        --button="No:1" \
        --button="S√≠!gtk-yes:0"

    if [ $? -eq 0 ]; then
        run_httpx_on_file "$OUTPUT_DIR/subdomains.txt" "$OUTPUT_DIR"
    fi
}

run_amass() {
    domain=$(yad --form \
        --title="Amass - Enumeraci√≥n Avanzada" \
        --window-icon="network-server" \
        --width=550 --center \
        --text="<b>Amass</b> - Enumeraci√≥n profunda de subdominios\n\n‚ö†Ô∏è <span foreground='orange'>Advertencia:</span> Este escaneo puede tardar 5-10 minutos" \
        --field="üåê Dominio objetivo:" \
        --button="gtk-cancel:1" \
        --button="Escanear!gtk-execute:0")

    if [ $? -ne 0 ]; then
        return
    fi

    domain=$(echo "$domain" | cut -d'|' -f1)

    if [ -z "$domain" ]; then
        return
    fi

    OUTPUT_DIR="$OUTPUT_BASE/$(date +%Y%m%d_%H%M%S)_${domain}_amass"
    mkdir -p "$OUTPUT_DIR"

    show_notification "Amass" "Iniciando enumeraci√≥n profunda de $domain..."

    run_in_terminal "Amass - $domain" \
        "amass enum -d $domain -o $OUTPUT_DIR/amass_subdomains.txt && \
         echo 'Subdominios encontrados: '$(wc -l < $OUTPUT_DIR/amass_subdomains.txt 2>/dev/null || echo 0)"
}

run_theharvester() {
    domain=$(yad --form \
        --title="TheHarvester - OSINT Completo" \
        --window-icon="mail-unread" \
        --width=550 --center \
        --text="<b>TheHarvester</b> - Recolecci√≥n de informaci√≥n OSINT\n\nBusca: Emails, subdominios, IPs, URLs, empleados" \
        --field="üåê Dominio objetivo:" \
        --button="gtk-cancel:1" \
        --button="Buscar!gtk-find:0")

    if [ $? -ne 0 ]; then
        return
    fi

    domain=$(echo "$domain" | cut -d'|' -f1)

    if [ -z "$domain" ]; then
        return
    fi

    OUTPUT_DIR="$OUTPUT_BASE/$(date +%Y%m%d_%H%M%S)_${domain}_harvester"
    mkdir -p "$OUTPUT_DIR"

    show_notification "TheHarvester" "Recolectando informaci√≥n de $domain..."

    run_in_terminal "TheHarvester - $domain" \
        "theHarvester -d $domain -b all -f $OUTPUT_DIR/theharvester"
}

run_shodan() {
    query=$(yad --form \
        --title="Shodan - B√∫squeda IoT" \
        --window-icon="search" \
        --width=600 --center \
        --text="<b>Shodan</b> - Motor de b√∫squeda de dispositivos IoT\n\nEjemplos de queries:\n‚Ä¢ <tt>hostname:example.com</tt>\n‚Ä¢ <tt>port:443</tt>\n‚Ä¢ <tt>org:\"Company Name\"</tt>" \
        --field="üîç Query de b√∫squeda:" "hostname:" \
        --button="gtk-cancel:1" \
        --button="Buscar!gtk-find:0")

    if [ $? -ne 0 ]; then
        return
    fi

    query=$(echo "$query" | cut -d'|' -f1)

    if [ -z "$query" ]; then
        return
    fi

    run_in_terminal "Shodan Search" "shodan search '$query'"
}

run_combo_recon() {
    domain=$(yad --form \
        --title="Combo Reconocimiento - TODAS las Herramientas" \
        --window-icon="package-x-generic" \
        --width=600 --center \
        --text="<b>Combo Completo</b> - Ejecutar todas las herramientas\n\nSe ejecutar√°n:\n‚Ä¢ Subfinder (r√°pido)\n‚Ä¢ Amass con timeout de 5 min\n‚Ä¢ TheHarvester\n\n‚è±Ô∏è Tiempo estimado: 10-15 minutos" \
        --field="üåê Dominio objetivo:" \
        --button="gtk-cancel:1" \
        --button="Iniciar!gtk-media-play:0")

    if [ $? -ne 0 ]; then
        return
    fi

    domain=$(echo "$domain" | cut -d'|' -f1)

    if [ -z "$domain" ]; then
        return
    fi

    OUTPUT_DIR="$OUTPUT_BASE/$(date +%Y%m%d_%H%M%S)_${domain}_combo"
    mkdir -p "$OUTPUT_DIR"

    show_notification "Combo Recon" "Ejecutando TODAS las herramientas en $domain..."

    run_in_terminal "Combo Recon - $domain" \
        "echo 'Ejecutando Subfinder...' && \
         subfinder -d $domain -all -o $OUTPUT_DIR/subfinder.txt -silent && \
         echo '' && \
         echo 'Ejecutando Amass (timeout 5 min)...' && \
         timeout 300 amass enum -d $domain -o $OUTPUT_DIR/amass.txt -silent 2>/dev/null && \
         echo '' && \
         echo 'Ejecutando TheHarvester...' && \
         theHarvester -d $domain -b all -f $OUTPUT_DIR/theharvester 2>/dev/null && \
         echo '' && \
         echo 'Combinando resultados...' && \
         cat $OUTPUT_DIR/*.txt 2>/dev/null | sort -u > $OUTPUT_DIR/all_subdomains.txt && \
         echo '' && \
         echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' && \
         echo 'RESULTADOS FINALES:' && \
         echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' && \
         echo 'Subdominios √∫nicos: '$(wc -l < $OUTPUT_DIR/all_subdomains.txt 2>/dev/null || echo 0) && \
         echo 'Guardado en: $OUTPUT_DIR/all_subdomains.txt'"
}

# ============================================================================
# MEN√ö DE AN√ÅLISIS WEB (MEJORADO)
# ============================================================================

menu_web() {
    while true; do
        choice=$(yad --list \
            --title="FAROSINT - An√°lisis Web" \
            --window-icon="applications-internet" \
            --width=900 --height=450 --center \
            --text="<b>Herramientas de An√°lisis de Aplicaciones Web</b>" \
            --column="Icono":IMG --column="ID":HD --column="Herramienta" --column="Descripci√≥n" \
            --no-headers \
            --print-column=2 \
            --button="gtk-go-back:1" \
            --button="Ejecutar!gtk-execute:0" \
            "emblem-web" "httpx" "Httpx" "Verificar URLs activas, status codes, t√≠tulos y tecnolog√≠as" \
            "applications-development" "whatweb" "WhatWeb" "Identificar CMS, frameworks, servidores y tecnolog√≠as web" \
            "security-high" "wafw00f" "Wafw00f" "Detectar Web Application Firewalls (WAF)")

        if [ $? -ne 0 ]; then
            main_menu
            return
        fi

        case $choice in
            "httpx") run_httpx ;;
            "whatweb") run_whatweb ;;
            "wafw00f") run_wafw00f ;;
        esac
    done
}

run_httpx() {
    result=$(yad --form \
        --title="Httpx - Verificaci√≥n de URLs" \
        --window-icon="emblem-web" \
        --width=600 --center \
        --text="<b>Httpx</b> - Verificar URLs activas y obtener informaci√≥n\n\nDetecta: Status codes, t√≠tulos, tecnolog√≠as, redirects" \
        --field="Tipo de input:":CB "URL √∫nica!Archivo de subdominios" \
        --field="URL o archivo:" "" \
        --button="gtk-cancel:1" \
        --button="Escanear!gtk-execute:0")

    if [ $? -ne 0 ]; then
        return
    fi

    tipo=$(echo "$result" | cut -d'|' -f1)
    input=$(echo "$result" | cut -d'|' -f2)

    if [ -z "$input" ]; then
        return
    fi

    OUTPUT_DIR="$OUTPUT_BASE/$(date +%Y%m%d_%H%M%S)_httpx"
    mkdir -p "$OUTPUT_DIR"

    if [ "$tipo" = "Archivo de subdominios" ]; then
        run_in_terminal "Httpx - Archivo" \
            "httpx -l '$input' -status-code -title -tech-detect -o $OUTPUT_DIR/alive_urls.txt"
    else
        run_in_terminal "Httpx - $input" \
            "echo '$input' | httpx -status-code -title -tech-detect -o $OUTPUT_DIR/result.txt"
    fi
}

run_httpx_on_file() {
    local file="$1"
    local output_dir="$2"

    run_in_terminal "Httpx - Verificaci√≥n de URLs" \
        "httpx -l '$file' -status-code -title -tech-detect -o $output_dir/alive_urls.txt && \
         echo 'URLs activas: '$(wc -l < $output_dir/alive_urls.txt 2>/dev/null || echo 0)"
}

run_whatweb() {
    url=$(yad --form \
        --title="WhatWeb - Identificaci√≥n de Tecnolog√≠as" \
        --window-icon="applications-development" \
        --width=550 --center \
        --text="<b>WhatWeb</b> - Fingerprinting de tecnolog√≠as web\n\nIdentifica: CMS, servidores, frameworks, JavaScript, plugins" \
        --field="üåê URL objetivo:" "https://" \
        --button="gtk-cancel:1" \
        --button="Analizar!gtk-find:0")

    if [ $? -ne 0 ]; then
        return
    fi

    url=$(echo "$url" | cut -d'|' -f1)

    if [ -z "$url" ]; then
        return
    fi

    run_in_terminal "WhatWeb - $url" "whatweb '$url' -v"
}

run_wafw00f() {
    url=$(yad --form \
        --title="Wafw00f - Detecci√≥n de WAF" \
        --window-icon="security-high" \
        --width=550 --center \
        --text="<b>Wafw00f</b> - Detectar Web Application Firewall\n\nIdentifica: Cloudflare, Akamai, AWS WAF, Imperva, etc." \
        --field="üåê URL objetivo:" "https://" \
        --button="gtk-cancel:1" \
        --button="Detectar!gtk-find:0")

    if [ $? -ne 0 ]; then
        return
    fi

    url=$(echo "$url" | cut -d'|' -f1)

    if [ -z "$url" ]; then
        return
    fi

    run_in_terminal "Wafw00f - $url" "wafw00f '$url'"
}

# ============================================================================
# MEN√ö DE ESCANEO DE PUERTOS (MEJORADO)
# ============================================================================

menu_portscan() {
    while true; do
        choice=$(yad --list \
            --title="FAROSINT - Escaneo de Puertos" \
            --window-icon="network-wired" \
            --width=900 --height=450 --center \
            --text="<b>Escaneo de Puertos con Nmap</b>" \
            --column="Icono":IMG --column="ID":HD --column="Tipo de Escaneo" --column="Descripci√≥n" --column="Duraci√≥n" \
            --no-headers \
            --print-column=2 \
            --button="gtk-go-back:1" \
            --button="Escanear!gtk-execute:0" \
            "emblem-default" "quick" "Nmap Quick" "Top 100 puertos m√°s comunes" "‚ö° ~1 minuto" \
            "emblem-important" "full" "Nmap Full" "Todos los 65535 puertos" "üê¢ ~10-15 minutos" \
            "emblem-system" "custom" "Nmap Custom" "Puertos espec√≠ficos personalizados" "‚ö° Variable" \
            "emblem-web" "service" "Service Detection" "Detecci√≥n de versiones de servicios" "‚ö° ~2-3 minutos")

        if [ $? -ne 0 ]; then
            main_menu
            return
        fi

        case $choice in
            "quick") run_nmap_quick ;;
            "full") run_nmap_full ;;
            "custom") run_nmap_custom ;;
            "service") run_nmap_service ;;
        esac
    done
}

run_nmap_quick() {
    target=$(yad --form \
        --title="Nmap Quick - Top 100 Puertos" \
        --window-icon="emblem-default" \
        --width=550 --center \
        --text="<b>Nmap Quick Scan</b>\n\nEscanea los 100 puertos m√°s comunes\n‚è±Ô∏è Duraci√≥n estimada: ~1 minuto" \
        --field="üéØ Target (IP o dominio):" \
        --button="gtk-cancel:1" \
        --button="Escanear!gtk-execute:0")

    if [ $? -ne 0 ]; then
        return
    fi

    target=$(echo "$target" | cut -d'|' -f1)

    if [ -z "$target" ]; then
        return
    fi

    OUTPUT_DIR="$OUTPUT_BASE/$(date +%Y%m%d_%H%M%S)_nmap"
    mkdir -p "$OUTPUT_DIR"

    run_in_terminal "Nmap Quick - $target" \
        "sudo nmap -F '$target' -oN $OUTPUT_DIR/nmap_quick.txt"
}

run_nmap_full() {
    target=$(yad --form \
        --title="Nmap Full - Escaneo Completo" \
        --window-icon="emblem-important" \
        --width=550 --center \
        --text="<b>Nmap Full Scan</b>\n\nEscanea TODOS los 65535 puertos\n\n‚ö†Ô∏è <span foreground='orange'>Advertencia:</span> Puede tardar 10-15 minutos" \
        --field="üéØ Target (IP o dominio):" \
        --button="gtk-cancel:1" \
        --button="Escanear!gtk-execute:0")

    if [ $? -ne 0 ]; then
        return
    fi

    target=$(echo "$target" | cut -d'|' -f1)

    if [ -z "$target" ]; then
        return
    fi

    OUTPUT_DIR="$OUTPUT_BASE/$(date +%Y%m%d_%H%M%S)_nmap"
    mkdir -p "$OUTPUT_DIR"

    run_in_terminal "Nmap Full - $target" \
        "sudo nmap -p- '$target' -oN $OUTPUT_DIR/nmap_full.txt"
}

run_nmap_custom() {
    result=$(yad --form \
        --title="Nmap Custom - Puertos Personalizados" \
        --window-icon="emblem-system" \
        --width=600 --center \
        --text="<b>Nmap Custom Scan</b>\n\nEspecifica qu√© puertos escanear\n\nEjemplos:\n‚Ä¢ <tt>80,443,8080</tt>\n‚Ä¢ <tt>1-1000</tt>\n‚Ä¢ <tt>22,80,443,3306,5432</tt>" \
        --field="üéØ Target:" \
        --field="üî¢ Puertos:" "80,443" \
        --button="gtk-cancel:1" \
        --button="Escanear!gtk-execute:0")

    if [ $? -ne 0 ]; then
        return
    fi

    target=$(echo "$result" | cut -d'|' -f1)
    ports=$(echo "$result" | cut -d'|' -f2)

    if [ -z "$target" ] || [ -z "$ports" ]; then
        return
    fi

    run_in_terminal "Nmap Custom - $target" \
        "sudo nmap -p '$ports' '$target'"
}

run_nmap_service() {
    target=$(yad --form \
        --title="Nmap Service Detection" \
        --window-icon="emblem-web" \
        --width=550 --center \
        --text="<b>Service & Version Detection</b>\n\nDetecta versiones de servicios running\nIncluye scripts NSE por defecto" \
        --field="üéØ Target (IP o dominio):" \
        --button="gtk-cancel:1" \
        --button="Escanear!gtk-execute:0")

    if [ $? -ne 0 ]; then
        return
    fi

    target=$(echo "$target" | cut -d'|' -f1)

    if [ -z "$target" ]; then
        return
    fi

    OUTPUT_DIR="$OUTPUT_BASE/$(date +%Y%m%d_%H%M%S)_nmap"
    mkdir -p "$OUTPUT_DIR"

    run_in_terminal "Nmap Service Detection - $target" \
        "sudo nmap -sV -sC '$target' -oN $OUTPUT_DIR/nmap_services.txt"
}

# ============================================================================
# MEN√ö DE VULNERABILIDADES (MEJORADO)
# ============================================================================

menu_vuln() {
    while true; do
        choice=$(yad --list \
            --title="FAROSINT - Detecci√≥n de Vulnerabilidades" \
            --window-icon="security-medium" \
            --width=900 --height=450 --center \
            --text="<b>Nuclei - Motor de detecci√≥n de vulnerabilidades</b>" \
            --column="Icono":IMG --column="ID":HD --column="Modo" --column="Descripci√≥n" \
            --no-headers \
            --print-column=2 \
            --button="gtk-go-back:1" \
            --button="Escanear!gtk-execute:0" \
            "security-low" "full" "Nuclei Full" "Todos los templates (CVEs, exploits, misconfigs)" \
            "security-high" "critical" "Nuclei Critical" "Solo vulnerabilidades CRITICAL y HIGH" \
            "security-medium" "custom" "Nuclei Custom" "Templates espec√≠ficos personalizados")

        if [ $? -ne 0 ]; then
            main_menu
            return
        fi

        case $choice in
            "full") run_nuclei_full ;;
            "critical") run_nuclei_critical ;;
            "custom") run_nuclei_custom ;;
        esac
    done
}

run_nuclei_full() {
    result=$(yad --form \
        --title="Nuclei Full - Escaneo Completo" \
        --window-icon="security-low" \
        --width=600 --center \
        --text="<b>Nuclei Full Scan</b>\n\nEscanea con TODOS los templates disponibles\nIncluye: CVEs, exploits, misconfigurations, exposures" \
        --field="Tipo de input:":CB "URL √∫nica!Archivo de URLs" \
        --field="URL o archivo:" "https://" \
        --button="gtk-cancel:1" \
        --button="Escanear!gtk-execute:0")

    if [ $? -ne 0 ]; then
        return
    fi

    tipo=$(echo "$result" | cut -d'|' -f1)
    input=$(echo "$result" | cut -d'|' -f2)

    if [ -z "$input" ]; then
        return
    fi

    OUTPUT_DIR="$OUTPUT_BASE/$(date +%Y%m%d_%H%M%S)_nuclei"
    mkdir -p "$OUTPUT_DIR"

    if [ "$tipo" = "Archivo de URLs" ]; then
        run_in_terminal "Nuclei Full - Archivo" \
            "nuclei -l '$input' -o $OUTPUT_DIR/nuclei_results.txt"
    else
        run_in_terminal "Nuclei Full - $input" \
            "nuclei -u '$input' -o $OUTPUT_DIR/nuclei_results.txt"
    fi
}

run_nuclei_critical() {
    url=$(yad --form \
        --title="Nuclei Critical - Solo Cr√≠ticas" \
        --window-icon="security-high" \
        --width=550 --center \
        --text="<b>Nuclei Critical Scan</b>\n\nEscanea solo vulnerabilidades CRITICAL y HIGH\n√ötil para auditor√≠as r√°pidas" \
        --field="üåê URL objetivo:" "https://" \
        --button="gtk-cancel:1" \
        --button="Escanear!gtk-execute:0")

    if [ $? -ne 0 ]; then
        return
    fi

    url=$(echo "$url" | cut -d'|' -f1)

    if [ -z "$url" ]; then
        return
    fi

    run_in_terminal "Nuclei Critical - $url" \
        "nuclei -u '$url' -s critical,high"
}

run_nuclei_custom() {
    result=$(yad --form \
        --title="Nuclei Custom - Templates Espec√≠ficos" \
        --window-icon="security-medium" \
        --width=650 --center \
        --text="<b>Nuclei Custom Scan</b>\n\nEscanea con templates espec√≠ficos\n\nEjemplos de templates:\n‚Ä¢ <tt>cves/2021/</tt>\n‚Ä¢ <tt>technologies/wordpress/</tt>\n‚Ä¢ <tt>exposures/configs/</tt>" \
        --field="üåê URL objetivo:" "https://" \
        --field="üìã Template ID o ruta:" "cves/" \
        --button="gtk-cancel:1" \
        --button="Escanear!gtk-execute:0")

    if [ $? -ne 0 ]; then
        return
    fi

    url=$(echo "$result" | cut -d'|' -f1)
    template=$(echo "$result" | cut -d'|' -f2)

    if [ -z "$url" ]; then
        return
    fi

    run_in_terminal "Nuclei Custom - $url" \
        "nuclei -u '$url' -t '$template'"
}

# ============================================================================
# MEN√ö DE RESULTADOS (MEJORADO)
# ============================================================================

menu_resultados() {
    if [ ! -d "$OUTPUT_BASE" ] || [ -z "$(ls -A $OUTPUT_BASE 2>/dev/null)" ]; then
        yad --info \
            --title="Resultados" \
            --window-icon="folder-saved-search" \
            --width=400 --center \
            --text="<b>No hay resultados guardados</b>\n\nA√∫n no has ejecutado ning√∫n escaneo." \
            --button="gtk-ok:0"
        main_menu
        return
    fi

    # Generar lista de resultados
    result_list=""
    while IFS= read -r dir; do
        size=$(du -sh "$OUTPUT_BASE/$dir" 2>/dev/null | cut -f1)
        date=$(stat -c %y "$OUTPUT_BASE/$dir" 2>/dev/null | cut -d' ' -f1)
        result_list="$result_list$dir|$date|$size|"
    done < <(ls -t "$OUTPUT_BASE" | head -20)

    choice=$(yad --list \
        --title="FAROSINT - Resultados de Escaneos" \
        --window-icon="folder-saved-search" \
        --width=900 --height=500 --center \
        --text="<b>√öltimos escaneos realizados</b>" \
        --column="Directorio" --column="Fecha" --column="Tama√±o" \
        --print-column=1 \
        --button="Abrir Carpeta:2" \
        --button="gtk-close:1" \
        $(echo "$result_list" | sed 's/|$//' | tr '|' ' '))

    ret=$?

    if [ $ret -eq 2 ]; then
        # Abrir explorador de archivos
        xdg-open "$OUTPUT_BASE" 2>/dev/null || thunar "$OUTPUT_BASE" 2>/dev/null
        menu_resultados
    elif [ $ret -eq 0 ] && [ -n "$choice" ]; then
        # Abrir directorio espec√≠fico
        xdg-open "$OUTPUT_BASE/$choice" 2>/dev/null || thunar "$OUTPUT_BASE/$choice" 2>/dev/null
        menu_resultados
    else
        main_menu
    fi
}

# ============================================================================
# MEN√ö DE UTILIDADES (MEJORADO)
# ============================================================================

menu_utilidades() {
    while true; do
        choice=$(yad --list \
            --title="FAROSINT - Utilidades y Mantenimiento" \
            --window-icon="preferences-system" \
            --width=850 --height=450 --center \
            --text="<b>Herramientas de Mantenimiento del Sistema</b>" \
            --column="Icono":IMG --column="ID":HD --column="Utilidad" --column="Descripci√≥n" \
            --no-headers \
            --print-column=2 \
            --button="gtk-go-back:1" \
            --button="Ejecutar!gtk-execute:0" \
            "system-software-update" "nuclei" "Actualizar Nuclei" "Actualizar templates de vulnerabilidades de Nuclei" \
            "system-upgrade" "gotools" "Actualizar Go Tools" "Actualizar Subfinder, Httpx, y otras herramientas Go" \
            "edit-clear-all" "clean" "Limpiar Resultados" "Eliminar resultados antiguos de escaneos" \
            "dialog-information" "status" "Ver Estado Sistema" "Ver estado del dashboard y servicios")

        if [ $? -ne 0 ]; then
            main_menu
            return
        fi

        case $choice in
            "nuclei") update_nuclei ;;
            "gotools") update_go_tools ;;
            "clean") clean_results ;;
            "status") show_status ;;
        esac
    done
}

update_nuclei() {
    (
    echo "# Actualizando templates de Nuclei..."
    echo "10"
    nuclei -update-templates
    echo "# Verificando versi√≥n..."
    echo "80"
    nuclei -version
    echo "# Completado"
    echo "100"
    ) | yad --progress \
        --title="Actualizar Nuclei" \
        --window-icon="system-software-update" \
        --width=500 --center \
        --text="Actualizando Nuclei templates..." \
        --auto-close \
        --no-cancel

    yad --info \
        --title="Actualizaci√≥n Completada" \
        --window-icon="emblem-default" \
        --width=400 --center \
        --text="<b>Nuclei actualizado correctamente</b>\n\nTemplates actualizados a la √∫ltima versi√≥n." \
        --button="gtk-ok:0"
}

update_go_tools() {
    run_in_terminal "Actualizar Go Tools" \
        "echo 'Actualizando Subfinder...' && \
         go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest 2>/dev/null && \
         echo 'Actualizando Httpx...' && \
         go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest 2>/dev/null && \
         echo 'Actualizando Nuclei...' && \
         go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest 2>/dev/null && \
         echo '' && \
         echo 'Versiones instaladas:' && \
         echo 'Subfinder:' $(subfinder -version 2>&1 | head -1) && \
         echo 'Httpx:' $(httpx -version 2>&1 | head -1) && \
         echo 'Nuclei:' $(nuclei -version 2>&1 | head -1)"
}

clean_results() {
    yad --question \
        --title="Limpiar Resultados" \
        --window-icon="edit-clear-all" \
        --width=500 --center \
        --text="<b>¬øEliminar TODOS los resultados?</b>\n\nEsto eliminar√° permanentemente todo el contenido de:\n<tt>$OUTPUT_BASE</tt>\n\n‚ö†Ô∏è <span foreground='red'>Esta acci√≥n no se puede deshacer</span>" \
        --button="Cancelar!gtk-cancel:1" \
        --button="Eliminar!gtk-delete:0"

    if [ $? -eq 0 ]; then
        rm -rf "$OUTPUT_BASE"/*
        yad --info \
            --title="Limpieza Completada" \
            --window-icon="emblem-default" \
            --width=400 --center \
            --text="<b>Resultados eliminados</b>\n\nTodos los escaneos anteriores han sido eliminados." \
            --button="gtk-ok:0"
    fi
}

show_status() {
    if pgrep -f "python3.*app.py" > /dev/null; then
        PID=$(pgrep -f "python3.*app.py")
        STATUS="<span foreground='green'><b>‚úì Dashboard CORRIENDO</b></span>\n\nPID: $PID\nURL: <a href='http://localhost:5000'>http://localhost:5000</a>"
        ICON="emblem-default"
    else
        STATUS="<span foreground='red'><b>‚úó Dashboard DETENIDO</b></span>\n\nEl dashboard no est√° corriendo actualmente."
        ICON="emblem-important"
    fi

    yad --info \
        --title="Estado del Sistema FAROSINT" \
        --window-icon="$ICON" \
        --width=450 --center \
        --text="$STATUS" \
        --button="gtk-ok:0"
}

# ============================================================================
# VERIFICACI√ìN E INICIO
# ============================================================================

# Verificar que YAD est√° instalado
if ! command -v yad &> /dev/null; then
    zenity --error \
        --text="Error: YAD no est√° instalado\n\nInstala con: sudo apt install yad" \
        --width=350 2>/dev/null || echo "Error: YAD no encontrado"
    exit 1
fi

# Crear directorio de output
mkdir -p "$OUTPUT_BASE"

# Iniciar men√∫ principal
main_menu
